name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write
  packages: write

env:
  JAVA_VERSION: '25'
  GRADLE_VERSION: 'wrapper'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: fourtune_test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:9.2.3
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x ./fourtune/gradlew
      
      - name: Run tests with Gradle
        working-directory: ./fourtune
        run: ./gradlew test --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          DB_URL: jdbc:postgresql://localhost:5432/fourtune_test_db
          DB_USERNAME: test_user
          DB_PASSWORD: test_password
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          ELASTICSEARCH_URIS: http://localhost:9200
      
      - name: Generate test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: '**/build/test-results/test/*.xml'
          reporter: java-junit

      - name: Upload test coverage
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: '**/build/reports/jacoco/test/jacocoTestReport.xml'
          flags: unittests
          name: codecov-umbrella

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Make Firebase Key File
        run: |
          mkdir -p ./fourtune/fourtune-api/src/main/resources
          echo '${{ secrets.FIREBASE_KEY }}' > ./fourtune/fourtune-api/src/main/resources/firebase-service-account.json

      - name: Grant execute permission for gradlew
        run: chmod +x ./fourtune/gradlew
      
      - name: Build with Gradle
        working-directory: ./fourtune
        run: ./gradlew build -x test --no-daemon
      
      - name: Upload fourtune-api artifact
        uses: actions/upload-artifact@v4
        with:
          name: fourtune-api-jar
          path: fourtune/fourtune-api/build/libs/*.jar
          retention-days: 7

      - name: Upload payment-service artifact
        uses: actions/upload-artifact@v4
        with:
          name: payment-service-jar
          path: fourtune/payment-service/build/libs/*.jar
          retention-days: 7

  docker-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download fourtune-api artifact
        uses: actions/download-artifact@v4
        with:
          name: fourtune-api-jar
          path: fourtune/fourtune-api/build/libs

      - name: Download payment-service artifact
        uses: actions/download-artifact@v4
        with:
          name: payment-service-jar
          path: fourtune/payment-service/build/libs

      - name: Make Firebase Key File for Docker
        run: |
          mkdir -p ./fourtune/fourtune-api/src/main/resources
          echo '${{ secrets.FIREBASE_KEY }}' > ./fourtune/fourtune-api/src/main/resources/firebase-service-account.json

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push fourtune-api image
        uses: docker/build-push-action@v5
        with:
          context: ./fourtune
          push: true
          build-args: MODULE_NAME=fourtune-api
          tags: ghcr.io/${{ github.repository_owner }}/fourtune-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push payment-service image
        uses: docker/build-push-action@v5
        with:
          context: ./fourtune
          push: true
          build-args: MODULE_NAME=payment-service
          tags: ghcr.io/${{ github.repository_owner }}/payment-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: development
      url: https://dev.fourtune.com
    
    steps:
      - name: Deploy to development server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USERNAME }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            cd /home/fourtune/fourtune || exit 1
            git pull origin develop || exit 1
            docker-compose -f docker-compose.dev.yml build app || exit 1
            docker-compose -f docker-compose.dev.yml up -d || exit 1
            docker system prune -af

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://api.fourtune.store
    
    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /home/ubuntu/fourtune
            git pull origin main
            cd fourtune
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --no-deps
            docker system prune -f
            # 4. 내부 헬스 체크 (외부 https가 막혀있으므로 localhost 사용)
            echo "Waiting for service to start..."
            sleep 30
            curl -f http://localhost:8080/actuator/health || echo "Warning: Health check failed but deployment finished."
#
#      - name: Health check
#        run: |
#          sleep 30
#          curl -f ${{ secrets.PROD_URL }}/actuator/health || exit 1


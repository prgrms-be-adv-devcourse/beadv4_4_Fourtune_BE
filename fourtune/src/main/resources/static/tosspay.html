<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://js.tosspayments.com/v2/standard"></script>

    <title>TossPayments 결제 승인 테스트</title>
</head>

<body class="bg-slate-50">
<div class="mx-auto max-w-2xl p-6">
    <h1 class="text-xl font-semibold text-slate-900">결제 요청 & 서버 승인 (Void Return)</h1>
    <p class="mt-1 text-sm text-slate-600">리다이렉트 후 서버(Void 반환)로 승인 요청</p>

    <div class="mt-6 rounded-xl border bg-white p-4 shadow-sm">
        <div class="flex items-center justify-between">
            <h2 class="text-base font-semibold text-slate-900">결제수단</h2>
            <span id="selectedBadge" class="rounded-full bg-blue-50 px-3 py-1 text-xs font-medium text-blue-700">CARD 선택됨</span>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
            <button id="CARD" type="button" class="rounded-lg border px-4 py-2 text-sm font-medium transition" onclick="selectPaymentMethod('CARD')">
                카드
            </button>
        </div>
    </div>

    <div class="mt-4 rounded-xl border bg-white p-4 shadow-sm">
        <h2 class="text-base font-semibold text-slate-900">요청 파라미터</h2>

        <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">

            <label class="block sm:col-span-2">
                <span class="text-sm font-medium text-blue-700">Access Token (Authorization 헤더)</span>
                <input id="accessToken" type="text" class="mt-1 w-full rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-sm outline-none focus:ring focus:ring-blue-500" placeholder="필요시 입력 (Bearer 토큰)" />
            </label>

            <label class="block sm:col-span-2">
                <span class="text-sm font-medium text-green-700">Server Confirm URL (POST)</span>
                <input id="serverConfirmUrl" class="mt-1 w-full rounded-lg border border-green-200 bg-green-50 px-3 py-2 text-sm outline-none focus:ring focus:ring-green-500" placeholder="http://localhost:8080/api/payments/toss/confirm" />
                <p class="mt-1 text-xs text-slate-500">인증 성공 후 이 주소로 결제 정보를 POST 전송합니다.</p>
            </label>

            <div class="col-span-full h-px bg-slate-100 my-2"></div>

            <label class="block">
                <span class="text-sm font-medium text-slate-700">clientKey</span>
                <input id="clientKey" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring" />
            </label>

            <label class="block">
                <span class="text-sm font-medium text-slate-700">customerKey</span>
                <input id="customerKey" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring" />
            </label>

            <label class="block">
                <span class="text-sm font-medium text-slate-700">amount.currency</span>
                <input id="currency" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring" placeholder="KRW" />
            </label>

            <label class="block">
                <span class="text-sm font-medium text-slate-700">amount.value</span>
                <input id="value" type="number" min="1" step="1" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring" placeholder="2000" />
            </label>

            <label class="block">
                <span class="text-sm font-medium text-slate-700">orderNo (숫자만)</span>
                <input id="orderNo" inputmode="numeric" autocomplete="off" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring" oninput="handleOrderNoInput(this)" />
            </label>

            <label class="block">
                <span class="text-sm font-medium text-slate-700">orderId (String 전송됨)</span>
                <input id="orderIdPreview" class="mt-1 w-full rounded-lg border bg-slate-50 px-3 py-2 text-sm text-slate-700 outline-none" readonly />
            </label>

            <label class="block sm:col-span-2">
                <span class="text-sm font-medium text-slate-700">orderName</span>
                <input id="orderName" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring" />
            </label>

            <label class="block sm:col-span-2">
                <span class="text-sm font-medium text-slate-700">Redirect URL (자동설정)</span>
                <input id="redirectUrl" class="mt-1 w-full rounded-lg border bg-slate-100 px-3 py-2 text-sm text-slate-500 outline-none" readonly />
            </label>

            <label class="block">
                <span class="text-sm font-medium text-slate-700">customerEmail</span>
                <input id="customerEmail" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring" />
            </label>

            <label class="block">
                <span class="text-sm font-medium text-slate-700">customerName</span>
                <input id="customerName" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring" />
            </label>
        </div>

        <div class="mt-5 flex items-center gap-2">
            <button type="button" class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800" onclick="requestPayment()">
                결제하기
            </button>

            <button type="button" class="rounded-lg border bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50" onclick="resetDefaults()">
                기본값 리셋
            </button>

            <span id="status" class="ml-auto text-sm text-slate-600 font-medium"></span>
        </div>
    </div>

    <div class="mt-4 rounded-xl border bg-white p-4 shadow-sm">
        <h2 class="text-base font-semibold text-slate-900">디버그 / 서버 응답</h2>
        <pre id="debug" class="mt-2 overflow-auto rounded-lg bg-slate-900 p-3 text-xs text-slate-100 min-h-[100px] whitespace-pre-wrap"></pre>
    </div>
</div>

<script>
    // -----------------------------
    // 초기화 및 유틸리티
    // -----------------------------
    let selectedPaymentMethod = "CARD";
    const SESSION_RANDOM_NUM = generateRandomDigits(8); // 유니크한 orderId를 위한 랜덤값

    function v(id) { return document.getElementById(id)?.value ?? ""; }
    function n(id) { return Number(document.getElementById(id)?.value ?? "0"); }

    function generateRandomDigits(len) {
        let out = "";
        for (let i = 0; i < len; i++) out += String(Math.floor(Math.random() * 10));
        return out;
    }

    function renderPaymentMethodUI() {
        const el = document.getElementById("CARD");
        if (el) {
            el.className = "rounded-lg border px-4 py-2 text-sm font-medium transition border-blue-300 bg-blue-50 text-blue-800";
        }
    }

    function handleOrderNoInput(inputEl) {
        inputEl.value = inputEl.value.replace(/\D+/g, ""); // 숫자만
        updateOrderIdPreview();
    }

    function updateOrderIdPreview() {
        const no = v("orderNo").trim();
        const preview = document.getElementById("orderIdPreview");
        if(preview) preview.value = no ? `ORDER-${no}-${SESSION_RANDOM_NUM}` : "";
    }

    // -----------------------------
    // TossPayments 클라이언트 생성 (수정됨)
    // -----------------------------
    function createPaymentClient() {
        // TossPayments 초기화 후 payment 객체 반환
        const tossPayments = TossPayments(v("clientKey").trim());
        return tossPayments.payment({ customerKey: v("customerKey").trim() });
    }

    // -----------------------------
    // 1. 결제 요청 (수정됨)
    // -----------------------------
    async function requestPayment() {
        const status = document.getElementById("status");
        const debug = document.getElementById("debug");

        try {
            const no = v("orderNo").trim();
            if (!no) throw new Error("orderNo를 입력해주세요.");

            // Redirect 후 복구를 위해 LocalStorage 저장
            localStorage.setItem("tp_accessToken", v("accessToken"));
            localStorage.setItem("tp_serverConfirmUrl", v("serverConfirmUrl"));

            status.textContent = "요청 준비중...";

            const currentUrl = window.location.href.split('?')[0];
            const orderId = `ORDER-${no}-${SESSION_RANDOM_NUM}`;

            const payload = {
                method: "CARD",
                amount: { currency: v("currency"), value: n("value") },
                orderId: orderId,
                orderName: v("orderName"),
                successUrl: currentUrl,
                failUrl: currentUrl,
                customerEmail: v("customerEmail"),
                customerName: v("customerName"),
                card: { useEscrow: false, flowMode: "DEFAULT", useCardPoint: false, useAppCardOnly: false }
            };

            debug.textContent = `[Request Payload]\n${JSON.stringify(payload, null, 2)}`;

            // ✅ [수정된 부분] 중괄호 {} 제거
            // createPaymentClient()가 바로 payment 객체를 줍니다.
            const payment = createPaymentClient();

            await payment.requestPayment(payload);

        } catch (e) {
            status.textContent = "에러 발생";
            debug.textContent = `[Error] ${e.message}`;
            console.error(e);
        }
    }

    // -----------------------------
    // 2. 리다이렉트 후 서버 승인 요청
    // -----------------------------
    async function checkRedirectParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const statusEl = document.getElementById("status");
        const debugEl = document.getElementById("debug");

        if (urlParams.has("paymentKey") && urlParams.has("orderId") && urlParams.has("amount")) {

            const paymentKey = urlParams.get("paymentKey");
            const orderId = urlParams.get("orderId");
            const amount = urlParams.get("amount");

            const savedToken = localStorage.getItem("tp_accessToken") || "";
            const savedServerUrl = localStorage.getItem("tp_serverConfirmUrl") || "";

            // UI 복구
            if(document.getElementById("accessToken")) document.getElementById("accessToken").value = savedToken;
            if(document.getElementById("serverConfirmUrl")) document.getElementById("serverConfirmUrl").value = savedServerUrl;

            statusEl.textContent = "인증 성공! 서버 승인 요청 중...";
            debugEl.textContent = `[Redirected Params]\npaymentKey: ${paymentKey}\norderId: ${orderId}\namount: ${amount}\n\n>> 서버(${savedServerUrl})로 POST 요청을 보냅니다...`;

            try {
                const requestBody = {
                    paymentKey: paymentKey,
                    orderId: orderId,
                    amount: Number(amount)
                };

                const response = await fetch(savedServerUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        ...(savedToken ? { "Authorization": `Bearer ${savedToken}` } : {})
                    },
                    body: JSON.stringify(requestBody)
                });

                // Controller void 반환 대응
                if (response.ok) {
                    statusEl.textContent = "최종 승인 성공 (200 OK)";
                    debugEl.textContent += `\n\n[Success]\n서버가 성공적으로 처리했습니다. (Status: ${response.status})`;

                    const text = await response.text();
                    if(text) debugEl.textContent += `\nResponse Body: ${text}`;

                } else {
                    statusEl.textContent = "서버 승인 실패";
                    const errorText = await response.text();
                    debugEl.textContent += `\n\n[Server Error (${response.status})]\n${errorText}`;
                }

            } catch (err) {
                statusEl.textContent = "네트워크 에러";
                debugEl.textContent += `\n\n[Fetch Error] ${err.message}`;
            }
        }
    }

    // -----------------------------
    // 기본값 설정
    // -----------------------------
    function resetDefaults() {
        document.getElementById("clientKey").value = "test_ck_5OWRapdA8dwjJb9WO69Bro1zEqZK";
        document.getElementById("customerKey").value = "MEMBER-5";
        document.getElementById("currency").value = "KRW";
        document.getElementById("value").value = 5000;
        document.getElementById("orderNo").value = "99";
        document.getElementById("orderName").value = "테스트 상품";
        document.getElementById("customerEmail").value = "test@example.com";
        document.getElementById("customerName").value = "김토스";

        // ✅ [변경됨] 요청하신 URL 반영
        document.getElementById("serverConfirmUrl").value = "http://localhost:8080/api/payments/toss/confirm";
        document.getElementById("accessToken").value = "";

        document.getElementById("redirectUrl").value = window.location.href.split('?')[0];

        updateOrderIdPreview();
        document.getElementById("status").textContent = "";
        document.getElementById("debug").textContent = "";
    }

    // 실행
    renderPaymentMethodUI();
    resetDefaults();
    checkRedirectParams();

</script>
</body>
</html>